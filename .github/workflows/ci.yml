name: CI

on:
  push:
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install jsonschema

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user strace linux-tools-common linux-tools-generic

      - name: Configure
        run: >
          cmake -S . -B build
          -DCMAKE_BUILD_TYPE=Release
          -DTRACELAB_BUILD_TESTS=ON
          -DTRACELAB_RUN_SCHEMA_TESTS=ON

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Select deterministic QEMU arch
        run: |
          HOST_ARCH="$(uname -m)"
          if [[ "${HOST_ARCH}" == "x86_64" ]] && command -v qemu-x86_64 >/dev/null 2>&1; then
            QEMU_ARCH="x86_64"
          elif command -v qemu-aarch64 >/dev/null 2>&1; then
            QEMU_ARCH="aarch64"
          elif command -v qemu-riscv64 >/dev/null 2>&1; then
            QEMU_ARCH="riscv64"
          else
            echo "No supported qemu target available on runner" >&2
            exit 1
          fi
          echo "QEMU_ARCH=${QEMU_ARCH}" >> "${GITHUB_ENV}"
          echo "Selected QEMU_ARCH=${QEMU_ARCH}"

      - name: Build microbench binaries
        run: bash scripts/build_microbench.sh

      - name: CI run + compare + threshold gate
        run: |
          mkdir -p out/ci

          ./build/tracelab doctor > out/ci/doctor.txt || true

          ./build/tracelab run --native --json out/ci/mem_bw_native.json -- ./microbench/mem_bw 32 2
          ./build/tracelab run --native --json out/ci/syscall_rate_native.json -- ./microbench/syscall_rate 50000

          python3 - <<'PY'
          from pathlib import Path
          payload = Path("out/ci/startup_io_payload.bin")
          target_size = 48 * 1024 * 1024
          chunk = (b"TraceLabStartupIOPayloadV1\n" * 1024)
          with payload.open("wb") as f:
              remaining = target_size
              while remaining > 0:
                  data = chunk if remaining >= len(chunk) else chunk[:remaining]
                  f.write(data)
                  remaining -= len(data)
          print(f"created deterministic startup payload: {payload} ({payload.stat().st_size} bytes)")
          PY

          if command -v sudo >/dev/null 2>&1; then
            sudo sh -c "sync; echo 3 > /proc/sys/vm/drop_caches" || true
          fi

          ./build/tracelab run \
            --native \
            --scenario-label startup_io \
            --cache-state cold \
            --json out/ci/startup_io_cold.json \
            -- python3 -c "import hashlib, pathlib; data=pathlib.Path('out/ci/startup_io_payload.bin').read_bytes(); print('startup_io', len(data), hashlib.sha256(data).hexdigest()[:16])"

          ./build/tracelab run \
            --native \
            --scenario-label startup_io \
            --cache-state warm \
            --json out/ci/startup_io_warm.json \
            -- python3 -c "import hashlib, pathlib; data=pathlib.Path('out/ci/startup_io_payload.bin').read_bytes(); print('startup_io', len(data), hashlib.sha256(data).hexdigest()[:16])"

          ./build/tracelab run --native --json out/ci/warmup_native.json -- /bin/echo ci-warmup >/dev/null
          ./build/tracelab run --qemu "${QEMU_ARCH}" --json out/ci/warmup_qemu.json -- /bin/echo ci-warmup >/dev/null

          native_args=()
          qemu_args=()
          for i in $(seq 1 5); do
            native_json="out/ci/protocol_native_${i}.json"
            qemu_json="out/ci/protocol_qemu_${i}.json"
            ./build/tracelab run --native --json "${native_json}" -- /bin/echo ci-protocol
            ./build/tracelab run --qemu "${QEMU_ARCH}" --json "${qemu_json}" -- /bin/echo ci-protocol
            native_args+=(--native "${native_json}")
            qemu_args+=(--qemu "${qemu_json}")
          done

          ./build/tracelab compare "${native_args[@]}" "${qemu_args[@]}" --json out/ci/protocol_compare.json | tee out/ci/compare.txt

          ./build/tracelab report out/ci/protocol_native_3.json > out/ci/native_report.txt
          ./build/tracelab report out/ci/protocol_qemu_3.json > out/ci/qemu_report.txt

          python scripts/check_regression.py \
            --config config/regression_thresholds.json \
            --compare out/ci/protocol_compare.json \
            --native-run out/ci/protocol_native_1.json \
            --native-run out/ci/protocol_native_2.json \
            --native-run out/ci/protocol_native_3.json \
            --native-run out/ci/protocol_native_4.json \
            --native-run out/ci/protocol_native_5.json \
            --qemu-run out/ci/protocol_qemu_1.json \
            --qemu-run out/ci/protocol_qemu_2.json \
            --qemu-run out/ci/protocol_qemu_3.json \
            --qemu-run out/ci/protocol_qemu_4.json \
            --qemu-run out/ci/protocol_qemu_5.json \
            --cold-run out/ci/startup_io_cold.json \
            --warm-run out/ci/startup_io_warm.json

      - name: Validate run JSON schema
        run: |
          python scripts/validate_schema.py --schema schema/result.schema.json --instance out/ci/mem_bw_native.json
          python scripts/validate_schema.py --schema schema/result.schema.json --instance out/ci/syscall_rate_native.json
          python scripts/validate_schema.py --schema schema/result.schema.json --instance out/ci/startup_io_cold.json
          python scripts/validate_schema.py --schema schema/result.schema.json --instance out/ci/startup_io_warm.json
          python scripts/validate_schema.py --schema schema/result.schema.json --instance out/ci/warmup_native.json
          python scripts/validate_schema.py --schema schema/result.schema.json --instance out/ci/warmup_qemu.json
          for i in $(seq 1 5); do
            python scripts/validate_schema.py --schema schema/result.schema.json --instance "out/ci/protocol_native_${i}.json"
            python scripts/validate_schema.py --schema schema/result.schema.json --instance "out/ci/protocol_qemu_${i}.json"
          done

      - name: Synthetic regression must fail gate
        run: |
          set +e
          python scripts/check_regression.py \
            --config config/regression_thresholds.json \
            --compare tests/parser_fixtures/synthetic_regression_compare.json
          status=$?
          set -e
          if [[ "${status}" -eq 0 ]]; then
            echo "Synthetic regression fixture was expected to fail gate but passed." >&2
            exit 1
          fi

      - name: Upload CI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tracelab-ci-artifacts
          path: |
            out/ci/**
            !out/ci/startup_io_payload.bin
